
###########################################################################

.PHONY: all clean strip install

###########################################################################

STUB_REGISTRY		:= src_libc/reg_stubs.txt
STUB_GEN_DIR		:= src_libc/stubs
STUB_GEN_SCRIPT		:= src_libc/gen_stubs.py

# Root Dir
ROOTDIR		:= ../..

# Object Dir
OBJDIR		:= obj

# Binary Dir
BINDIR		:= bin

# Target Name
TARGET		:= libc.a

# Compiler Flags
CFLAGS		:= -O2
CFLAGS		+= -I src_libc
CFLAGS		+= -I $(ROOTDIR)/inc_System
CFLAGS		+= -I $(ROOTDIR)/inc_Public
CFLAGS		+= -I $(ROOTDIR)/inc_Private
#CFLAGS		+= -DDEBUG
#CFLAGS		+= -gstabs
CFLAGS		+= -W
CFLAGS		+= -Wall
CFLAGS		+= -MMD
CFLAGS		+= -MP
CFLAGS		+= -mcrt=clib2

# Linker Flags
LDFLAGS		:=

# Link Libraries
LIBS		:=

# Empty Source File List (Will grow)
SRCS		:=

# Host SYS we compile on
HOSTOS		:= $(shell uname)

###########################################################################
# Set Compiler

ifeq ($(HOSTOS),AmigaOS)

LS			:= list
RM			:= delete
AR			:= ar
CC			:= gcc
STRIP		:= strip
MKDIR		:= makedir FORCE
COPY		:= copy
SDK			:= sdk:clib2

# --

else ifeq ($(HOSTOS),Linux)

LS			:= ls -lort
RM			:= rm -rf
AR			:= ppc-amigaos-ar
CC			:= ppc-amigaos-gcc
STRIP		:= ppc-amigaos-strip
MKDIR		:= mkdir -p
COPY		:= cp
SDK			:= /SDK/clib2

else

$(error Unknown Host SYS type: $(HOSTOS).)

endif

###########################################################################
# All stubs for libc

# string.h
#SRCS		+= src_libc/stubs.c

###########################################################################

SRCS		:= $(wildcard $(STUB_GEN_DIR)/*.c)
OBJS		:= $(patsubst %.c,$(OBJDIR)/%.o,$(SRCS))
DEPS		:= $(patsubst %.c,$(OBJDIR)/%.d,$(SRCS))

all: stubs $(BINDIR)/$(TARGET)

.PHONY: stubs
stubs:
	@echo "Generating stub files from registry..."
	python3 $(STUB_GEN_SCRIPT)

###########################################################################

$(BINDIR)/$(TARGET): $(OBJS)
	$(RM) $@
	$(AR) rcs $@ $(OBJS)

###########################################################################

# Include dependency files
-include $(DEPS)

###########################################################################

clean:
	$(RM) $(OBJS) $(DEPS) $(BINDIR)/$(TARGET) $(STUB_GEN_DIR)/*

###########################################################################

install:
	$(COPY) $(BINDIR)/libc.a $(SDK)/lib/
	$(COPY) $(BINDIR)/libm.a $(SDK)/lib/
	$(COPY) $(BINDIR)/libsocket.a $(SDK)/lib/
	$(COPY) $(BINDIR)/libpthread.a $(SDK)/lib/

###########################################################################

strip:
	@$(LS)		$(BINDIR)/$(TARGET)
	@$(STRIP)	$(BINDIR)/$(TARGET)
	@$(LS)		$(BINDIR)/$(TARGET)

###########################################################################

# Pattern rule for C source files
$(OBJDIR)/%.o: %.c
	@mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -c $< -o $@

# Pattern rule for ASM (.s) source files
$(OBJDIR)/%.o: %.s
	@mkdir -p $(dir $@)
	$(CC) -c -mregnames $< -o $@

###########################################################################
