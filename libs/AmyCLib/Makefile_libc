###########################################################################

.PHONY: all clean strip install stubs build

###########################################################################

STUB_REGISTRY		:= src_libc/reg_stubs.txt
GEN_STUB_DIR		:= src_libc/gen-stubs
CUSTOM_STUB_DIR		:= src_libc/custom-stubs
STUB_DIRS			:= $(GEN_STUB_DIR) $(CUSTOM_STUB_DIR)
STUB_GEN_SCRIPT		:= src_libc/gen_stubs.py

# Root Dir
ROOTDIR				:= ../..

# Object Dir
OBJDIR				:= obj

# Binary Dir
BINDIR				:= bin

# Target Name
TARGET				:= libc.a

# Compiler Flags
CFLAGS				:= -O2
CFLAGS				+= -I src_libc
CFLAGS				+= -I $(ROOTDIR)/inc_System
CFLAGS				+= -I $(ROOTDIR)/inc_Public
CFLAGS				+= -I $(ROOTDIR)/inc_Private
#CFLAGS				+= -DDEBUG
#CFLAGS				+= -gstabs
CFLAGS				+= -W
CFLAGS				+= -Wall
CFLAGS				+= -MMD
CFLAGS				+= -MP
CFLAGS				+= -mcrt=amyclib

# Linker Flags
LDFLAGS				:=

# Link Libraries
LIBS				:=

# Host SYS we compile on
HOSTOS				:= $(shell uname)

###########################################################################
# Set Compiler

ifeq ($(HOSTOS),AmigaOS)

LS					:= list
RM					:= delete
AR					:= ar
CC					:= gcc
STRIP				:= strip
MKDIR				:= makedir FORCE
COPY				:= copy
SDK					:= sdk:amyclib

else ifeq ($(HOSTOS),Linux)

LS					:= ls -lort
RM					:= rm -rf
AR					:= ppc-amigaos-ar
CC					:= ppc-amigaos-gcc
STRIP				:= ppc-amigaos-strip
MKDIR				:= mkdir -p
COPY				:= cp
SDK					:= /SDK/amyclib

else
$(error Unknown Host SYS type: $(HOSTOS).)
endif

###########################################################################
# Sources/Objects â€” use deferred evaluation so wildcards are re-scanned
# after "stubs" runs and generates files in $(GEN_STUB_DIR).

STUB_SRCS	= $(foreach d,$(STUB_DIRS),$(wildcard $(d)/*.c))
OBJS		= $(patsubst %.c,$(OBJDIR)/%.o,$(STUB_SRCS))
DEPS		= $(patsubst %.c,$(OBJDIR)/%.d,$(STUB_SRCS))

###########################################################################

all: stubs $(BINDIR)/$(TARGET)

# Generate stubs BEFORE compiling anything
stubs:
	@echo "Generating stub files from registry into $(GEN_STUB_DIR)..."
	$(MKDIR) $(GEN_STUB_DIR)
	python3 $(STUB_GEN_SCRIPT)

# Build the archive
$(BINDIR)/$(TARGET): $(OBJS)
	mkdir -p $(dir $@)
	$(RM) $@
	$(AR) rcs $@ $(OBJS)

###########################################################################
# Pattern rules

# C sources
$(OBJDIR)/%.o: %.c
	mkdir -p $(dir $@)
	$(CC) $(CFLAGS) -c $< -o $@

# ASM sources
$(OBJDIR)/%.o: %.s
	mkdir -p $(dir $@)
	$(CC) -c -mregnames $< -o $@

###########################################################################
# Includes
ifneq ($(DEPS),)
-include $(DEPS)
endif

###########################################################################

clean:
	$(RM) $(OBJS) $(DEPS)
	# Only remove generated stubs, keep your custom ones
	$(RM) $(GEN_STUB_DIR)/*.c

install:
	$(COPY) $(BINDIR)/libc.a $(SDK)/lib/
	$(COPY) $(BINDIR)/libm.a $(SDK)/lib/
	$(COPY) $(BINDIR)/libsocket.a $(SDK)/lib/
	$(COPY) $(BINDIR)/libpthread.a $(SDK)/lib/

strip:
	@$(LS)		$(BINDIR)/$(TARGET)
	@$(STRIP)	$(BINDIR)/$(TARGET)
	@$(LS)		$(BINDIR)/$(TARGET)

###########################################################################
